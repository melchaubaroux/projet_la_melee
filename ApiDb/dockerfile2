# Choix de l'image 
FROM postgres:latest

# Mettre à jour les dépendances
RUN apt-get update && apt-get install -y \
    python3  \
    python3-pip \
    python3-venv \
    && rm -rf /var/lib/apt/lists/*


WORKDIR /app
WORKDIR /tmp
# Copiez le reste des fichiers de l'application dans le répertoire de travail

RUN cd /app

COPY . .
# Copiez le fichier des dépendances dans le répertoire de travail
# COPY requirements.txt .


RUN ls




# Cloner le dépôt pgvector
RUN cd /tmp \
    git clone --branch v0.7.4 https://github.com/pgvector/pgvector.git  \
    cd pgvector  \
    make  \
    make install # may need sudo  \
    rm -rf /tmp/pgvector \
    cd ..
# RUN git clone https://github.com/pgvector/pgvector.git
# Compiler et installer pgvector
# WORKDIR /tmp/pgvector
# RUN make clean && \
#     make OPTFLAGS="" && \
#     make install && \
#     mkdir /usr/share/doc/pgvector && \
#     cp LICENSE README.md /usr/share/doc/pgvector && \
#     rm -rf /tmp/pgvector


# Créer  un environnement virtuel Python
RUN python3 -m venv /env

RUN ls /env
# Activer l'environnement virtuel et installer pip
RUN /env/bin/python -m pip install --upgrade pip

# RUN python3 --version && pip3 --version
# RUN python3 -m pip install --upgrade pip
# RUN cat requirements.txt


# Installez les dépendances de l'application
# RUN pip install -r requirements.txt
RUN pip install -r httpx



# Créer l'extension vector
# RUN echo "CREATE EXTENSION IF NOT EXISTS vector;" | psql -U postgres -d postgres


# Exposer la port 5432
EXPOSE 5432

# lancement de l'api 
CMD ["python", "Apidb.py"]

